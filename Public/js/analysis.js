Rice_Gene="LOC_Os11g47830,LOC_Os08g06800,LOC_Os01g65650,LOC_Os01g57230,LOC_Os01g55070,LOC_Os01g24440,LOC_Os06g46060,LOC_Os08g43210,LOC_Os12g41650,LOC_Os12g32170,LOC_Os11g37260,LOC_Os10g41440,LOC_Os10g34660,LOC_Os10g31510,LOC_Os10g31100,LOC_Os08g40420,LOC_Os08g39250,LOC_Os08g32520,LOC_Os07g25690,LOC_Os06g36510,LOC_Os06g01460,LOC_Os04g35550,LOC_Os04g26850,LOC_Os04g22340,LOC_Os02g39010,LOC_Os01g67770,LOC_Os01g59260,LOC_Os01g58430,LOC_Os01g55260,LOC_Os01g04840,LOC_Os01g04730,LOC_Os09g08160,LOC_Os09g08160,LOC_Os09g08270,LOC_Os12g39490,LOC_Os12g07380,LOC_Os11g39120,LOC_Os10g06230,LOC_Os10g06030,LOC_Os09g31340,LOC_Os09g31310,LOC_Os08g40310,LOC_Os08g39630,LOC_Os07g45150,LOC_Os07g42970,LOC_Os06g17370,LOC_Os04g04390,LOC_Os03g64030,LOC_Os02g32469,LOC_Os02g32460,LOC_Os01g66140,LOC_Os01g66140,LOC_Os01g66140,LOC_Os01g66140,LOC_Os01g56370,LOC_Os01g56320,LOC_Os01g42934,LOC_Os01g41850,LOC_Os08g42140,LOC_Os02g41980,LOC_Os11g09050,LOC_Os11g08760,LOC_Os11g06630,LOC_Os09g06950,LOC_Os07g34170,LOC_Os05g46600,LOC_Os04g05560,LOC_Os02g41850,LOC_Os02g16580,LOC_Os11g13790,LOC_Os11g08470,LOC_Os11g08420,LOC_Os09g18020,LOC_Os09g15940,LOC_Os08g44610,LOC_Os05g30770,LOC_Os04g13820,LOC_Os02g16970,LOC_Os01g70030,LOC_Os01g02830,LOC_Os11g08445,LOC_Os10g01008,LOC_Os08g38710,LOC_Os08g14470,LOC_Os07g03730,LOC_Os07g01390,LOC_Os04g07380,LOC_Os04g06100,LOC_Os04g06090,LOC_Os03g02370,LOC_Os01g02550,LOC_Os01g02440,LOC_Os11g10500,LOC_Os11g09418,LOC_Os11g08460,LOC_Os11g08410,LOC_Os09g16930,LOC_Os07g32580,LOC_Os07g31220,LOC_Os06g42590,LOC_Os06g38780,LOC_Os06g38650,LOC_Os04g06180,LOC_Os02g42750,LOC_Os02g17430,LOC_Os01g70040,LOC_Os01g08020,LOC_Os01g02810,LOC_Os07g28644,LOC_Os06g37690,LOC_Os06g41180,LOC_Os06g39270,LOC_Os05g30454,LOC_Os02g48640,LOC_Os02g05744,LOC_Os07g25740,LOC_Os07g25740,LOC_Os06g15540,LOC_Os01g44270,LOC_Os12g18700,LOC_Os12g01810,LOC_Os11g08460,LOC_Os11g08460,LOC_Os06g17550,LOC_Os03g13320,LOC_Os08g12640,LOC_Os03g12850,LOC_Os03g05520,LOC_Os01g43050,LOC_Os06g16740,LOC_Os06g15910";
Maize_Gene= "AC149810.2_FG008,AC185305.3_FG003,AC189750.4_FG004,AC197355.3_FG001,AC203985.4_FG001,AC207722.2_FG009,AC208915.3_FG010,AC215260.3_FG003,AC217050.4_FG007,AC217897.3_FG010,AC233887.1_FG006,AC234513.1_FG005,GRMZM2G002910,GRMZM2G003426,GRMZM2G004161,GRMZM2G004516,GRMZM2G005066,GRMZM2G005939,GRMZM2G006964,GRMZM2G007012,GRMZM2G007729,GRMZM2G008263,GRMZM2G008696,GRMZM2G010871,GRMZM2G010987,GRMZM2G011269,GRMZM2G012758,GRMZM2G013152,GRMZM2G013200,GRMZM2G013430,GRMZM2G013630,GRMZM2G014902,GRMZM2G015804,GRMZM2G015889,GRMZM2G015908,GRMZM2G016281,GRMZM2G016734,GRMZM2G018627,GRMZM2G018820,GRMZM2G024668,GRMZM2G024705,GRMZM2G025175,GRMZM2G027183,GRMZM2G028218,GRMZM2G028535,GRMZM2G028986,GRMZM2G029079,GRMZM2G029506,GRMZM2G031628,GRMZM2G033230,GRMZM2G033846,GRMZM2G033885,GRMZM2G034471,GRMZM2G034797,GRMZM2G035579,GRMZM2G035933,GRMZM2G036880,GRMZM2G036918,GRMZM2G037015,GRMZM2G038931,GRMZM2G039886,GRMZM2G039996,GRMZM2G040095,GRMZM2G040298,GRMZM2G041442,GRMZM2G042323,GRMZM2G044132,GRMZM2G044902,GRMZM2G045473,GRMZM2G046849,GRMZM2G047002,GRMZM2G048281,GRMZM2G050234,GRMZM2G050307,GRMZM2G051256,GRMZM2G053140,GRMZM2G053434,GRMZM2G053946,GRMZM2G054807,GRMZM2G055469,GRMZM2G056093,GRMZM2G057281,GRMZM2G058595,GRMZM2G059801,GRMZM2G061492,GRMZM2G062458,GRMZM2G063238,GRMZM2G063756,GRMZM2G065244,GRMZM2G065928,GRMZM2G065989,GRMZM2G066413,GRMZM2G066489,GRMZM2G067171,GRMZM2G068294,GRMZM2G069694,GRMZM2G070475,GRMZM2G071100,GRMZM2G077436,GRMZM2G077942,GRMZM2G078373,GRMZM2G079559,GRMZM2G079949,GRMZM2G081521,GRMZM2G083408,GRMZM2G083655,GRMZM2G084515,GRMZM2G084859,GRMZM2G085661,GRMZM2G085854,GRMZM2G087254,GRMZM2G089282,GRMZM2G090105,GRMZM2G092363,GRMZM2G092427,GRMZM2G092813,GRMZM2G092817,GRMZM2G093096,GRMZM2G093849,GRMZM2G096753,GRMZM2G097972,GRMZM2G098460,GRMZM2G098596,GRMZM2G101818,GRMZM2G102760,GRMZM2G102959,GRMZM2G103013,GRMZM2G103945,GRMZM2G104549,GRMZM2G104942";
v4_example = "Zm00001d048342,Zm00001d049946,Zm00001d021596,Zm00001d024572,Zm00001d044401,Zm00001d039840,Zm00001d032230,Zm00001d028547,Zm00001d003750,Zm00001d020179,Zm00001d032318,Zm00001d000175,Zm00001d025752,Zm00001d049282,Zm00001d052194,Zm00001d015785,Zm00001d032923,Zm00001d033091,Zm00001d035124,Zm00001d012847,Zm00001d028154,Zm00001d012847,Zm00001d028199,Zm00001d003925,Zm00001d033136,Zm00001d031332,Zm00001d010422,Zm00001d013111,Zm00001d011081,Zm00001d047618,Zm00001d021763,Zm00001d012417,Zm00001d053787,Zm00001d023301,Zm00001d044300,Zm00001d020977,Zm00001d039000,Zm00001d001857,Zm00001d045537,Zm00001d029601,Zm00001d029602,Zm00001d004301,Zm00001d027613,Zm00001d013741,Zm00001d002564,Zm00001d044189,Zm00001d007108,Zm00001d029611,Zm00001d042887,Zm00001d046530,Zm00001d021784,Zm00001d043571,Zm00001d037519,Zm00001d049786,Zm00001d039674,Zm00001d037477,Zm00001d039194,Zm00001d002859,Zm00001d049157,Zm00001d044921,Zm00001d046500,Zm00001d052020,Zm00001d048006,Zm00001d048710,Zm00001d048711,Zm00001d006467,Zm00001d002301,Zm00001d005550,Zm00001d024200,Zm00001d026599,Zm00001d027499,Zm00001d047204,Zm00001d023238,Zm00001d053828,Zm00001d018161,Zm00001d053042"
$(".p_example").click(function () {
    if ($("#species").val() == "Maize") {
        $("#geneid").val(Maize_Gene);
    }
    if ($("#species").val() == "Rice") {
        $("#geneid").val(Rice_Gene);
    }
});
$(".v4_example").click(function () {
    if ($("#species").val() == "Maize") {
        $("#geneid").val(v4_example);
    }
    if ($("#species").val() == "Rice") {
        // $("#geneid").val(Rice_Gene);
        alert("species error!");
    }
});

function goBack() {
        $('.main-info').remove();
        $('.main-genes').show();
}


$(function() {

    var xhr = null;
    var hajax = $(".ajax_ajax").val();
    var infor = $(".find_infor").val();
    var printfgene = $(".printgene").val();
    var newDotNum = [];
    var networkData = {
        module: [],
        co: []
    };
    $("#traitid").keyup(function( event ) {
        if(event.keyCode==13){
            $("#searchBox").hide();
        }
        else{
       
        var inputText = $.trim(this.value);
        if (inputText != "") { //检测键盘输入的内容是否为空，为空就不发出请求  
            xhr = $.ajax({
                type: 'GET',
                url: hajax,
                cache: false,
                //不从浏览器缓存中加载请求信息  
                data: {
                    "keyword":inputText,
                    "species":$('#species').val()
                },
                //向服务器端发送的数据  
                dataType: 'json',
                //服务器返回数据的类型为json  
                success: function(data) {

                    if (data&&data.length != 0) { //检测返回的结果是否为空 
                    // console.log(data[1]); 
                        var lists = "<ul>";
                        for(var i=0;i<data.length;i++){
                            lists += "<li>" + data[i] + "</li>";
                        }

                        lists += "</ul>";
                        $("#searchBox").html(lists).show(); //将搜索到的结果展示出来

                        $('#searchBox ul').on('click','li',function(){
                        
                            $("#traitid").val($(this).text()); //点击某个li就会获取当前的值
                            $("#searchBox").hide();
                        });
                    } else {
                        $("#searchBox").hide();
                    }
                }
            });
        } else {
            $("#searchBox").hide(); //没有查询结果就隐藏搜索框
        }
    } 
    });


    $.post(infor,
        {
                species:$("#species").val(),
            },
            function(data){
                var da = JSON.parse(data);
                da.sort();
                $("#study option").remove();
                for(var i=0;i<da.length;i++){
                    $("#study").append($('<option>').attr('value',da[i]).html(da[i]));
                }
                $("#study").multiselect('refresh'); 
                $("#study").multiselect("widget").find(":checkbox").each(function(){
                    this.click();
                 });
                
            },"TEXT");
        
            $("#study_ms").click();



    if($("#ty").val()=="Trait"){
            $("#trait_input").show();
            $("#searchBox").show();
            $("#gene_input").hide();
    }

   $("#ty").change(function(){
        var vs = $("#ty").val(); 
         if(vs=="Trait"){
            $("#top option").remove();
            $("#top").append($('<option>').attr('value',"1").html("100%"));  
            $("#top").append($('<option>').attr('value',"0.05").html("5%"));
            $("#top").append($('<option>').attr('value',"0.1").html("10%"));
            $("#top").append($('<option>').attr('value',"0.25").html("25%"));  
            $("#top").append($('<option>').attr('value',"0.5").html("50%"));
            
            $("#trait_input").show();
            $("#gene_input").hide();
         }
         if(vs=="Gene"){
            $("#top option").remove();
            $("#top").append($('<option>').attr('value',"1").html("100%"));    
            $("#trait_input").hide();
            $("#gene_input").show();
         }
    }); 
   $("#species").change(function(){
    var sp = $(this).val();
    var vs = $("#ty").val();
    $('#traitid').val('');
    $("#geneid").val('');
    if(sp == "Maize"){
        $("#ld option").remove();
        $("#ld").append($('<option>').attr('value',"10Kb").html("10Kb"));
        $("#ld").append($('<option>').attr('value',"25Kb").html("25Kb"));
    } 
    if(sp == "Rice"){
        $("#ld option").remove();
        $("#ld").append($('<option>').attr('value',"25Kb").html("25Kb"));
        $("#ld").append($('<option>').attr('value',"50Kb").html("50Kb"));
    }
    $("#study_ms").click();
    $.post(infor,
        {
                species:$("#species").val(),
            },
            function(data){
                var da = JSON.parse(data);
                da.sort();
                $("#study option").remove();
                for(var i=0;i<da.length;i++){
                    $("#study").append($('<option>').attr('value',da[i]).html(da[i]));
                }
                $("#study").multiselect('refresh'); 
                $("#study").multiselect("widget").find(":checkbox").each(function(){
                    this.click();
                 });
                
            },"TEXT");
        
            $("#study_ms").click();

   });

    // function chiSquaredTest(a,b){
    //     var qw =(2+a+b)*(a-b)*(a-b);
    //     var pw =(1+a)*(1+b)*(a+b)*2;
    //     return qw/pw;
    // }
    function cmn(n,m){
        var a=1;
        var b=1;
        for(var i=1;i<=m;i++){
            a=a*i;
            b=b*n;
            n=n-1;
        }
        return b/a;
    }
    function cjh(N,M,n,k){
        p1=0;
        for(var j=0;j<k;j++){
        p1=p1+(cmn(M,j)*cmn(N-M,n-j))/cmn(N,n);
        }
        return(1-p1);
    }
    //GO时阶乘太大，取近似
    function cmnsi(n,m){
        var c=1;
        for(var i=1;i<=m;i++){
            c= c*(n/i)
            n=n-1;
        }
        return c;
    }
    function cjhsi(N,M,n,k){
        p1=0;
        for(var j=0;j<k;j++){
        p1=p1+(cmnsi(M,j)*cmnsi(N-M,n-j))/cmnsi(N,n);
        }
        return(1-p1);
    }
    //消除加载动画并提供下载
    function isshow(){ 
        if(icount == 3){
            console.log(countda2);
            console.log(countda3);
            console.log(countda4);
            if(networkData['co']) var enrichCo = networkData['co'].length;
            else var enrichCo = 0;
            var enrichMoArray = [];
            console.log(networkData['module']);
            var enrichMo = 0;
            for(var i = 0; i < networkData['module'].length; i++) {
                var enrichFlag = true;
                for(var j = 0; j < enrichMoArray.length; j++) {
                    if( enrichMoArray[j] === networkData['module'][i][0] ) {
                        enrichFlag = false;
                        break;
                    }    
                }
                if(enrichFlag) enrichMoArray.push(networkData['module'][i][0]);
            }
            enrichMo = enrichMoArray.length;
            console.log(enrichMoArray);
            enrichMoArray = enrichMoArray.slice(0,3).join(', ');
            $('#smallpic').remove();
            $('.enrich_table').remove();
            $('.genes-down-button').remove();
            $('#genes-down-info').remove();            
            $('#tab-content1').append(
                "<table class='enrich_table'>"+
                "<tr><th>&nbsp Type &nbsp </th><th>Enrichment(Co-expression)</th>"+
"<th>Key Terms(Modules)</th><th>Details</th></tr>"+
    
                "<tr><td> &nbsp TO &nbsp </td><td class = 'enrich'><a onclick=$(\'#tab2\').click(); >"+"enriched in"+" " + countda2 +" " + "terms"+"</a></td>"+
                "<td><a class='nowrap'>"+ down1[6][0]+"...</a></td><td><a class='botton_download' id='TO_link'>links</a></td></tr>"+
    
                "<tr><td>GO</td><td class = 'enrich'><a onclick=$(\'#tab3\').click();>"+"enriched in"+" " + countda3 +" " + "terms"+"</a></td>"+
                "<td><a class='nowrap' onclick=$(\'#tab3\').click()>"+ down2[6][0]+"...</a></td><td><a class='botton_download' id='GO_link'>links</a></td></tr>"+
    
                "<tr><td>PC</td><td class = 'enrich'><a onclick=$(\'#tab4\').click();>"+"enriched in"+" " + countda4 +" " + "terms"+"</a></td>"+
                "<td><a class='nowrap' onclick=$(\'#tab4\').click()>"+ down3[6][0]+"...</a></td><td><a class='botton_download' id='PC_link'>links</a></td></tr>"+
    
                "<tr><td>CO</td><td class = 'enrich'><a onclick=$(\'#tab5\').click()>Included "+
                 enrichCo 
                 +" co-expression genes and&nbsp"+
                 enrichMo
                 +" Modules</a></td>"+
                "<td class='nowrap'><a onclick=$(\'#tab5\').click();>"+
                 enrichMoArray
                +" ...</a></td><td><a class='botton_download' id='CO_link'>links</a></td></tr>"+                
                "</table>"+
                "<p id='genes-down-info'>Please click on each type (TO, GO, PC and CO green rectangle frame) to get a detailed information page, which including the chart and table.”</p>"+
                "<a class='genes-down-button' href='../Genes/download.html'>Gene’s information link</a>"
        );
        get_table(countda2,down1,'to','tab-content2','table_infor1');
        get_table(countda3,down2,'go','tab-content3','table_infor2');
        get_table(countda4,down3,'pc','tab-content4','table_infor3');
        getCoTable(networkData, 'table-co', 'table-module', 'tab-content5');

        $(".nowrap").each(function(){
            if($(this).html() == "undefined..."){
                $(this).html("no enrichment");
            }
          });
        $(".enrich a").each(function(){
            if($(this).html() == "enriched in 0 terms"){
                $(this).html("no enrichment");
            }
          });
            icount =0;
            

    
            $("#TO_link").click(function(){
                if(linkda2==0){
                    alert("no enrichment!");
                    return false;
                }
                else{           
                $.ajax({
                    url: '../Analysis/un_download.html',
                    type: 'post',
                    data: {down1:link1,name:"TO_link__"},
                    success: function(data){
                        document.getElementById("unLink").click();
                    }
                });
                }
            });
            $("#GO_link").click(function(){
                if(linkda3==0){
                    alert("no enrichment!");
                    return false;
                }
                else{
                    $.ajax({
                        url: '../Analysis/un_download.html',
                        type: 'post',
                        data: {down1:link2,name:"GO_link__"},
                        success: function(data){
                            document.getElementById("unLink").click();
                        }
                    });
                }
            });
            $("#PC_link").click(function(){
                if(linkda4==0){
                    alert("no enrichment!");
                    return false;
                }
                else{
                    $.ajax({
                        url: '../Analysis/un_download.html',
                        type: 'post',
                        data: {down1:link3,name:"PC_link__"},
                        success: function(data){
                            document.getElementById("unLink").click();
                        }
                    });
                }
            });
    $("#CO_link").click(function(){
        $.ajax({
            url: '../Analysis/co_download.html',
            type: 'post',
            data: {networkData:networkData},
            success: function(data){
                document.getElementById("networkLink").click();
            }
        });

        // $.post('../Analysis/co_download.html',{networkData: networkData},function(data){
        //     console.log(data)
        // })
    });

    hiding();

    }
        else{
            icount++;
        }
    }

    function getCoTable(data, name1, name2, tableName) {
        if( data['module'] == [] && data['co'] == [] ) return;
        var tableContent = "";

        data['module'].forEach( function( ele, index ) {
            tableContent += "<tr><td>" + ele[0] + 
                            "</td><td>" + ele[1] +
                            "</td><td>" + ele[2] + 
                            "</td></tr>"
            if( index === data['module'].length - 1 ) tableContent += '</table>';    
        });

        $("#"+tableName).append(
            "<table id='" + name2 + "'><tr>" +
            "<th>moduleID</th>" +
            "<th>gene</th>" +
            "<th>v4</th></tr>" + tableContent         
        )

        tableContent = "";

        data['co'].forEach( function( ele, index ) {
            tableContent += "<tr><td>" + ele[0] + 
                            "</td><td>" + ele[1] +
                            "</td><td>" + ele[2] + 
                            "</td><td>" + ele[3] +                             
                            "</td></tr>"
            if( index === data['co'].length - 1 ) tableContent += '</table>';    
        });

        $("#"+tableName).append(
            "<table id='" + name1 + "'><tr>" +
            "<th>moduleID</th>" +
            "<th>gene1</th>" +
            "<th>gene2</th>" +  
            "<th>value</th></tr>" + tableContent         
        )
    }

    function get_table(a,b,name,table_name,infor_name){
        if(a>0){
            // $("#" + table_name).empty();
        $("#"+table_name).append(
            "<table id='"+name+"'class='over_hidden'>"+
                 " <th>Queryitem</th>"+
                 " <th>No-queryitem</th>"+
                 " <th>Querytotal</th>"+
                 " <th>Bgitem</th>"+
                 " <th>No-bgitem</th>"+
                 " <th>Bgtotal</th>"+
                 " <th>Term</th>"+
                 " <th>Pvalue</th>"+
                 " <th>Rqueryitem-rate</th>"+
                 " <th>Bgitem-rate</th>"+
                "</tr></table>"
            );
            for(var m=0;m<a;m++){
                if (b[7][m] == "NaNe-Infinity"){
                    b[7][m] ="1e-8";
                }
                $("#"+name).append("<tr>"+
                "<td>"+ b[0][m] +"</td>"+
                "<td>"+ b[1][m] +"</td>"+
                "<td>"+ b[2][m] +"</td>"+
                "<td>"+ b[3][m] +"</td>"+
                "<td>"+ b[4][m] +"</td>"+
                "<td>"+ b[5][m] +"</td>"+
                "<td>"+ b[6][m] +"</td>"+
                "<td>"+ b[7][m] +"</td>"+
                "<td>"+ b[8][m] +"</td>"+
                "<td>"+ b[9][m] +"</td>"+
                  "</tr>");
            }
            $("." + infor_name).empty();
            $("." + infor_name).append( "<ul><li>Queryitem - # genes in query gene list;</li>" +
                "<li>Noqueryitem - # genes not associated with the annotation item;</li>" +
                "<li>Querytotal -  Total number of genes in query gene list;</li>" +
                "<li>bgitem - # genes associated with the annotated item in the whole genome;</li>" +
                "<li>nobgitem -  # genes not associated with the annotaed item in the whole genome;</li>" +
                "<li>Bgtotal - Total number of genes in the whole genome;</li>" +
                "<li>Term - Annotated functional item;</h5>" +
                "<li>Pvalue -  Signficance of enrichment analysis;</li>" +
                "<li>Queryitemrate - The rate of genes associated with the annotated item in query gene list;</li>" +
                "<li>Bgitemrate - The rate of genes associated with the annotated item in the whole genome.</li></ul>");
        }
        else{
            return false;
        }
    }
    Array.prototype.Exists=function(v){
        var b=false;
        for(var i=0;i<this.length;i++)
            {
                if(this[i]==v)
                    {b=true;break;}
            }
            return b;
    }
    function loading(describe){
        var count = 0;
        if($('#mask').css('display') == 'none'){
          $('#mask').show();
          $('#mask-content').show();
          $('html,body').addClass('ovfHiden');
        }
        setInterval(function(){
          var text = '';
          count++;
          for(var i = 0; i < count % 4; i++){
            text += '.';
          }
          $('#mask-content').text(describe+text);
        },1000)
        
    }
    
    function hiding(){
        $('#mask').hide();
        $('#mask-content').hide();
        $('html,body').removeClass('ovfHiden');
        count = 0;
    }


    
    var href2 = $(".ajax_href2").val();
    var href3 = $(".ajax_href3").val();
    var href4 = $(".ajax_href4").val();
    var href5 = $(".ajax_href5").val();
    var find = $(".ajax_find").val();

    $("#submit_T").click(function(){
        
        $("#tab1").click(function() {
            $("#tab2").removeClass("gene-tab-active");
            $("#tab3").removeClass("gene-tab-active");
            $("#tab4").removeClass("gene-tab-active");
            $("#tab5").removeClass("gene-tab-active");
            $(this).addClass("gene-tab-active");
            $("#tab-content5").hide();
            $("#tab-content4").hide();
            $("#tab-content2").hide();
            $("#tab-content3").hide();
            $("#tab-content1").show();
        });
        $("#tab2").click(function() {
            $("#tab1").removeClass("gene-tab-active");
            $("#tab3").removeClass("gene-tab-active");
            $("#tab4").removeClass("gene-tab-active");
            $("#tab5").removeClass("gene-tab-active");
            $("#tab2").addClass("gene-tab-active");
            $("#tab-content5").hide();
            $("#tab-content4").hide();
            $("#tab-content1").hide();
            $("#tab-content3").hide();
            $("#tab-content2").show();
        });
        $("#tab3").click(function() {
            $("#tab1").removeClass("gene-tab-active");
            $("#tab2").removeClass("gene-tab-active");
            $("#tab4").removeClass("gene-tab-active");
            $("#tab5").removeClass("gene-tab-active");
            $("#tab3").addClass("gene-tab-active");
            $("#tab-content5").hide();
            $("#tab-content4").hide();
            $("#tab-content1").hide();
            $("#tab-content2").hide();
            $("#tab-content3").show();
        });
        $("#tab4").click(function() {
            $("#tab1").removeClass("gene-tab-active");
            $("#tab2").removeClass("gene-tab-active");
            $("#tab4").removeClass("gene-tab-active");
            $("#tab3").removeClass("gene-tab-active");
            $("#tab4").addClass("gene-tab-active");
            $("#tab-content1").hide();
            $("#tab-content2").hide();
            $("#tab-content3").hide();
            $("#tab-content5").hide();
            $("#tab-content4").show();
        });
        $("#tab5").click(function() {
            $("#tab1").removeClass("gene-tab-active");
            $("#tab2").removeClass("gene-tab-active");
            $("#tab4").removeClass("gene-tab-active");
            $("#tab3").removeClass("gene-tab-active");
            $("#tab5").addClass("gene-tab-active");
            $("#tab-content3").hide();
            $("#tab-content4").hide();
            $("#tab-content1").hide();
            $("#tab-content2").hide();
            $("#tab-content5").show();
        }); 

        var canvas = document.getElementById('canvas_network');
        echarts.dispose(canvas);
        $('.download-link').remove(); 
        $('#table-co').remove();     
        $('#to').remove();     
        $('#go').remove();     
        $('#pc').remove();             
        $('#table-module').remove();             
        var myChart = echarts.init(canvas);
        var option = {}
        var _series = {}
        target = [];
        var co_gene = [];// 保存一对共表达基因
        var typee = $("#ty").val();  
        var species = $("#species").val();  
        var res = [];
        networkData = {
            module: [],
            co: []
        };
        icount = 0;
        countda2 = 0;
        countda3 = 0;
        countda4 = 0;
        linkda2 = 0;
        linkda3 = 0;
        linkda4 = 0;
        qp1 = new Array();
        qp2 = new Array();
        qp3 = new Array();
          
        down1 = new Array();
        down2 = new Array();
        down3 = new Array();
        var type =[0,1,2,3,4,5,6,7,8,9];        
        type.forEach(function(s){
            down1[s] = new Array();
            down2[s] = new Array();
            down3[s] = new Array();
        });
        link1 = new Array();
        link2 = new Array();
        link3 = new Array();

        type.forEach(function (s) {
            link1[s] = new Array();
            link2[s] = new Array();
            link3[s] = new Array();
        });
 
        var ld = $("#ld").val();  
        var top = $("#top").val();

        if(typee == "Gene"){
            var new_res = $('#geneid').val().split(/,|，|\s/);
            var res = [];
            //AC149810.2_FG003,AC183927.3_FG004,AC184699.3_FG005, AC196059.3_FG003 
            new_res.map(function (_res, index) {
                // console.log(_res+"--"+index);
                if(_res != "" && _res.length > 8)  res.push($.trim(_res));
                else _res.split(index,1);
            });

            var hasRes = [];
            for(var i = 0; i < res.length; i++){
                var flag = false;
                for(var j = 0; j < hasRes.length; j++) {
                    if(res[i] === hasRes[j]){                         
                        flag = true; break;
                    }
                }//去重 
                if(!flag) hasRes.push(res[i])
            }    
            res = hasRes;

            console.log(res)
            if( res.length < 5 ){
                alert('Too little inputs!(Between 5 and 600)');
                return false;
            }else if (res.length > 600) {
                alert('Too many inputs!(Between 5 and 600)');
                return false;
            }
            if($("#species").val() === "Maize") {
                var hasV4 = false;
                var hasV3 = false;
                res.forEach(function(el, index, arr) {
                    /^Zm/g.test( el ) === true? hasV4 = true: hasV3 = true;
                })
                console.log( hasV4 +""+ hasV3)
                if( hasV4 === hasV3 ) {
                    alert(' V3 and V4 cannot be mixed in !');
                    return;
                } else if( hasV4 === true ) {
                    $.post($('.v3tov4').val(), {
                        gene: res
                    }, function(data){
                       if(data != null) {
                           res = data;
                           var hasRes = [];
                           for(var i = 0; i < res.length; i++){
                               var flag = false;
                               for(var j = 0; j < hasRes.length; j++) {
                                   if(res[i] === hasRes[j]){                         
                                       flag = true; break;
                                   }
                               }//去重 
                               if(!flag) hasRes.push(res[i])
                           }    
                           res = hasRes;
                           loading('Analyzing data');
                           printgene();
                           axisAjax();//柱状图
                           networkAjax();   //network 图
                           console.log(res);
                           return;
                       } else {
                           alert("V4 gene is not querying!");
                           return;
                       } 
                    })
                } else {
                    loading('Analyzing data');
                    printgene();
                    axisAjax();//柱状图
                    networkAjax();   //network 图
                }   
            } else {
            loading('Analyzing data');
            // $.ajax({
            //     url:href2,
            //     data:{species:species,gene:res,ld:ld},
            //     dataType:"TEXT",
            //     type:"POST",
            //     success: function(data2){       
            //         var da2 = JSON.parse(data2);
            //         console.log(da2); 
            //     }
            //     });
            //     $.ajax({
            //         url:href3,
            //         data:{species:species,gene:res,ld:ld},
            //         dataType:"TEXT",
            //         type:"POST",
            //         success: function(data2){       
            //             var da2 = JSON.parse(data2);
            //             console.log(da2); 
            //         }
            //         });
            //         $.ajax({
            //             url:href4,
            //             data:{species:species,gene:res,ld:ld},
            //             dataType:"TEXT",
            //             type:"POST",
            //             success: function(data2){       
            //                 var da2 = JSON.parse(data2);
            //                 console.log(da2); 
            //             }
            //             });
            printgene();
            axisAjax();//柱状图
            networkAjax();   //network 图
            }
        }
        if(typee == "Trait"){
        var res = $('#traitid').val();
    //性状时
        $.ajax({
        url:find,
        data:{species:species,gene:res},
        dataType:"TEXT",
        type:"POST",
        success:function(data){
            var data = JSON.parse(data);
            console.log(data);
            data['data'] = data['data'].filter(function(item,val,Array){
                return item.pvalue != "no";
            });
            var study_val =$("#study").val();
                data['data'] = data['data'].filter(function(item,val,Array){
                    // return item.pvalue != "no";
                    return study_val.Exists(item.ref_infor);

                });
            var ref = [];
            var gene = [];  
            for(var m=0 ; m<data['count'].length;m++){
                ref[m] = [];
                for(var n=0;n<data['data'].length;n++){
                    if(data['count'][m].id_ref == data['data'][n].id_ref){
                        ref[m].push(data['data'][n]);
                    }
                }
                if(ref[m].length){
                    ref[m].sort(function(a,b){
                    return Number(b.pvalue)-Number(a.pvalue);
                });
                }
                var len = Math.ceil(ref[m].length*top);
                ref[m] = ref[m].slice(0,len);
                for(var j=0;j<ref[m].length;j++){
                    gene.push(ref[m][j].gene_refgene);
                }
            }
            res = gene;
            var hasRes = [];
            for(var i = 0; i < res.length; i++){
                var flag = false;
                for(var j = 0; j < hasRes.length; j++) {
                    if(res[i] === hasRes[j]){                         
                        flag = true; break;
                    }
                }//去重 
                if(!flag) hasRes.push(res[i])
            }    

            res = hasRes;
            // 第二张表
            loading('Analyzing data');
            printgene();
            
            axisAjax();        //柱状图

            networkAjax();   //network 图
}

});
}

function tofix2(a,b){
    if(b<=0.01){
        a.push(0.01); 
    }
    if(b>0.01){
        a.push(b.toFixed(2));
    }  
}
function num2e(num){0
    var p = Math.floor(Math.log(num)/Math.LN10);
    var n = (num * Math.pow(10, -p)).toFixed(2);
    return n + 'e' + p;

}
function printgene(){
    var tra;
    if($("#ty").val()=="Trait"){
    tra = $("#traitid").val();
    }
    else {tra ="11";}

    $.post(printfgene,{gene:res,select:$("#species").val(),type:$("#ty").val(),tra:tra},
            function(data){
                var da = JSON.parse(data);
                console.log(da);  
            },"TEXT");
}
function axisAjax(){ 
            //gene时第二张表
            $.ajax({
                url:href2,
                data:{species:species,gene:res,ld:ld},
                dataType:"TEXT",
                type:"POST",
                success: function(data2){       
                    var da = JSON.parse(data2);
                    console.log(da); 
            if(da['TO_ID'].length == 0) {
                $('#table2').empty();
                $("#table2").css("height","100");
                $("#table2").append($('<h3>').html("NO ENRICHMENT.....")); 
                isshow();
                return false;
            }
            var data_21 = new Array();
            var data_22 = new Array();
            var data_23 = new Array();
            var data_24 = new Array();
            for(var i=0;i<da['TO_ID'].length;i++){
                linkda2++;
                qp1[i] = cjh(da['r'], da['t'][i], da['s'], da['h'][i]);
                link1[0].push(da['h'][i]);
                link1[1].push(da['s'] - da['h'][i]);
                link1[2].push(da['s']);
                link1[3].push(da['t'][i]);
                link1[4].push(da['r'] - da['t'][i]);
                link1[5].push(da['r']);
                link1[6].push(da['TO_annotation'][i]);
                link1[7].push(num2e(qp1[i]));
                tofix2(link1[8], 100 * da['h'][i] / da['s']);
                tofix2(link1[9], 100 * da['t'][i] / da['r']);

                if (qp1[i] < 0.05 && da['h'][i]>=2){
                countda2++;
                if(countda2 < 10){
                    data_21.push(da['TO_annotation'][i]);
                    tofix2(data_22,100*da['h'][i]/da['s']);                    
                    tofix2(data_23,100*da['t'][i]/da['r']);
                    data_24.push(num2e(qp1[i]));
                }
                down1[0].push(da['h'][i]);
                down1[1].push(da['s']-da['h'][i]);
                down1[2].push(da['s']);
                down1[3].push(da['t'][i]);
                down1[4].push(da['r']-da['t'][i]);
                down1[5].push(da['r']);
                down1[6].push(da['TO_annotation'][i]);
                down1[7].push(num2e(qp1[i]));
                tofix2(down1[8],100*da['h'][i]/da['s']);                    
                tofix2(down1[9],100*da['t'][i]/da['r']);
                }
                }
            if(data_21.length==0){
                $('#table2').empty();
                $("#table2").css("height","100");
                $("#table2").append($('<h3>').html("NO ENRICHMENT....."));
            }
            if(data_21.length>0){
                $('#table2').empty();
                $("#table2").css("height","600");
                var Cha2 = document.getElementById('table2');
                echarts.dispose(Cha2);
                var Chart2 = echarts.init(Cha2);
            var option2 = {
        // title: {
        //         text: $("#species").val(),
        //         subtext: '数据来自TO_enrichment'
        //         },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
                }
            },
        legend: {
            data: ['Input','Background'],
        },
        grid: {
            left: '3%',
            right: '15%',
            bottom: '30%',
            containLabel: true
        },
        yAxis: {
            type: 'value',
            boundaryGap: [0, 0.01],         
            name: "Percent of genes",
        },
        xAxis: {
        // show : false,
        // gridIndex:1,
            type: 'category',
        data: data_21,
        name: "TO_annotation",
        max:9,
        axisLine:{
        show:false,
        },
        axisLabel: {  
            interval: 0,  
            rotate:60 ,
            textStyle: {
            color: 'blue',
            fontFamily: 'sans-serif',
            fontSize: 14,
            fontStyle: 'italic',
        },
        },
        },
        series: [
        {
        name: 'Input',
        type: 'bar',
        color:['rgba(25, 183, 207,0.5)'],
        data: data_22,
        },
        {
        name: 'Background',
        type: 'bar',
        color:['#00FFFF'],
        data: data_23,
        },
        {
        name: 'p',
        type: 'bar',
        data: data_24,  
        color:['#FFFFFF'],
        }]
        };            
        Chart2.setOption(option2);  
        var img = new Image();
         img.src = Chart2.getDataURL({
              pixelRatio: 2,
         });
        //  myChart.on('mousedown', function (params) {
        //     // 控制台打印数据的名称
        //     console.log(params.name);
        // });
          $('#table2').before("<a class='download-link' href='"+img.src+"' target='blank' >click here to see HD map !</a>");
        }
        isshow();
                }
            });
            
        $.ajax({
        url:href3,
        data:{species:species,gene:res},
        dataType:"TEXT",
        type:"POST",
        success: function(data){
        var da = JSON.parse(data);
        console.log(da);
        if(da['GO_ID'].length==0) {
            $('#table3').empty();
            $("#table3").css("height","100");
            $("#table3").append($('<h3>').html("NO ENRICHMENT.....")); 
            isshow();
            return false;
        }
        var data_31 = new Array();
        var data_32 = new Array();
        var data_33 = new Array();
        var data_34 = new Array();
        for (var i = 0; i < da['t'].length; i++) {
            linkda3++;
            qp2[i] = cjhsi(da['r'], da['t'][i], da['s'], da['h'][i]);
            link2[0].push(da['h'][i]);
            link2[1].push(da['s'] - da['h'][i]);
            link2[2].push(da['s']);
            link2[3].push(da['t'][i]);
            link2[4].push(da['r'] - da['t'][i]);
            link2[5].push(da['r']);
            link2[6].push(da['Function'][i]);
            link2[7].push(num2e(qp2[i]));
            tofix2(link2[8], 100 * da['h'][i] / da['s']);
            tofix2(link2[9], 100 * da['t'][i] / da['r']);
            if (qp2[i] < 0.05 && da['h'][i] >= 2){
                countda3++;
            if(countda3<10){
                data_31.push(da['Function'][i]);
                tofix2(data_32,100*da['h'][i]/da['s']);
                tofix2(data_33,100*da['t'][i]/da['r']);
                data_34.push(num2e(qp2[i]));
            }
            down2[0].push(da['h'][i]);
            down2[1].push(da['s']-da['h'][i]);
            down2[2].push(da['s']);
            down2[3].push(da['t'][i]);
            down2[4].push(da['r']-da['t'][i]);
            down2[5].push(da['r']);
            down2[6].push(da['Function'][i]);
            down2[7].push(num2e(qp2[i]));
            tofix2(down2[8],100*da['h'][i]/da['s']);
            tofix2(down2[9],100*da['t'][i]/da['r']);
            }
            }
            console.log(countda3);
        if(data_31.length==0){
            $('#table3').empty();
            $("#table3").css("height","100");
            $("#table3").append($('<h3>').html("NO ENRICHMENT....."));
        }
        if(data_31.length>0){
            $('#table3').empty();
            $("#table3").css("height","600");
            var Cha3 = document.getElementById('table3');
            echarts.dispose(Cha3);
            var Chart3 = echarts.init(Cha3);
        var option3 = {
        // title: {
        //         text: $("#species").val(),
        //         subtext: '数据来自TO_enrichment'
        //         },
        tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'shadow'
            }
        },
        legend: {
            data: ['Input', 'Background'],
        },
        grid: {
        left: '3%',
        right: '15%',
        bottom: '30%',
        containLabel: true
        },
        yAxis: {
        type: 'value',
        boundaryGap: [0, 0.01],    
        name: "Percent of genes",
        },
        xAxis: {
        type: 'category',
        name: "Function",
        data: data_31,
        max:9,
        axisLabel: {  
        interval: 0,  
        rotate:40 ,
        textStyle: {
        color: 'blue',
        fontFamily: 'sans-serif',
        fontSize: 14,
        fontStyle: 'italic',
        fontWeight: 'bold'
        },
        },
        },
        series: [
        {
        name: 'Input',
        type: 'bar',
        data: data_32,
        },
        {
        name: 'Background',
        type: 'bar',
        data: data_33
        },
        {name: 'p',
        type: 'bar',
        data: data_34,
        color:['#FFFFFF'],
        }]
        };            
        Chart3.setOption(option3); 
        var img = new Image(); 
        img.src = Chart3.getDataURL({
            pixelRatio: 2,
          });         
          $('#table3').before("<a class='download-link' href='"+img.src+"' target='blank'>click here to see HD map !</a>");
        }

        isshow();
        }
        });     
        $.ajax({
        url:href4,
        data:{species:species,gene:res},
        dataType:"TEXT",
        type:"POST",
        success: function(datat){
            var da = JSON.parse(datat);
            console.log(da);
            if(da['TO_ID'].length==0) {
                $('#table4').empty();
                $("#table4").css("height","100");
                $("#table4").append($('<h3>').html("NO ENRICHMENT.....")); 
                isshow();
                return false;
            }
            var data_41 = new Array();
            var data_42 = new Array();
            var data_43 = new Array();
            var data_44 = new Array();
            for(var i=0;i<da['TO_ID'].length;i++){
                linkda4++;
                qp3[i] = cjh(da['r'], da['t'][i], da['s'], da['h'][i]);
                link3[0].push(da['h'][i]);
                link3[1].push(da['s'] - da['h'][i]);
                link3[2].push(da['s']);
                link3[3].push(da['t'][i]);
                link3[4].push(da['r'] - da['t'][i]);
                link3[5].push(da['r']);
                link3[6].push(da['TO_ID'][i]);
                link3[7].push(num2e(qp3[i]));
                tofix2(link3[8], 100 * da['h'][i] / da['s']);
                tofix2(link3[9], 100 * da['t'][i] / da['r']);
                 if (qp3[i] < 0.05 && da['h'][i] >= 2){
                    countda4++;
                if(countda4<10){
                    data_41.push(da['TO_ID'][i]);
                    tofix2(data_42,100*da['h'][i]/da['s']);                    
                    tofix2(data_43,100*da['t'][i]/da['r']);
                    data_44.push(num2e(qp3[i]));
                }
                down3[0].push(da['h'][i]);
                down3[1].push(da['s']-da['h'][i]);
                down3[2].push(da['s']);
                down3[3].push(da['t'][i]);
                down3[4].push(da['r']-da['t'][i]);
                down3[5].push(da['r']);
                down3[6].push(da['TO_ID'][i]);
                down3[7].push(num2e(qp3[i]));
                tofix2(down3[8],100*da['h'][i]/da['s']);                    
                tofix2(down3[9],100*da['t'][i]/da['r']);
                }
            }  
            
            if(data_41.length==0){
                $('#table4').empty();
                $("#table4").css("height","100");
                $("#table4").append($('<h3>').html("NO ENRICHMENT....."));
            } 
            if(data_41.length>0){
                $('#table4').empty();
                $("#table4").css("height","600");
                var Cha4 = document.getElementById('table4');
                echarts.dispose(Cha4);
                var Chart4 = echarts.init(Cha4);
            var option4 = {
        // title: {
        //         text: $("#species").val(),
        //         subtext: '数据来自TO_enrichment'
        //         },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
                }
            },
        legend: {
            data: ['Input', 'Background'],
        },
        grid: {
            left: '3%',
            right: '15%',
            bottom: '30%',
            containLabel: true
        },
        yAxis: {
            type: 'value',
            boundaryGap: [0, 0.01],      
            name: "Percent of genes",
        },
        xAxis: {
            type: 'category',
        name: "pathway",
        data: data_41,
        max:9,
        axisLabel: {  
            interval: 0,  
            rotate:40 ,
            textStyle: {
            color: 'blue',
            fontFamily: 'sans-serif',
            fontSize: 14,
            fontStyle: 'italic',
            fontWeight: 'bold'
        },
        },
        },
        series: [
        {
        name: 'Input',
        type: 'bar',
        color:['rgba(107, 197 , 53,0.7)'],
        data: data_42,
        },
        {
        name: 'Background',
        type: 'bar',
        color:['#836FFF'],
        data: data_43
        },
        {name: 'p',
        type: 'bar',
        data: data_44,
        color:['#FFFFFF'],        
        }]
        };            
        Chart4.setOption(option4);
        var img = new Image();
        img.src = Chart4.getDataURL({
            pixelRatio: 2,
          });
          $('#table4').before("<a class='download-link' href='"+img.src+"' target='blank' >click here to see HD map !</a>");              
        } 
        isshow();
        }
        });   
        }

    // 基于准备好的dom，初始化echarts实例
    //---------------------------------------------html移过来的js 
  
    //-------------------------------------------------------------------
      var network = document.getElementsByClassName("network_module");
      var n = 0; //模块数量
      var dotNum = [];      //模块中的点数
      var module_id = [];  //模块名
      var module_gene = []; //模块中的基因名
      var _interval = 40; //数轴多少份
      var point = []; //   每个聚类的点坐标的复制，用于其他函数的使用
      var newDotPoint = []; //已产生的基因的坐标
      var circlePoint = []; // 各个模块的圆心，用于画圆
      var pointColor = [
          '#FF5733','#80FF33','#FFDA33','#33FFAF',
          '#339CFF','#9033FF','#FF33AF'
          ]; //新增色点的颜色 
      var moduleColor = [
          '#888895','#889588','#959088','#908895'
          ];  
  
      var gene = []; //返回的基因列表     
  

          //loading('Analyzing data');
          function networkAjax () {          
            $.post(href5,{gene:res,typee:typee,species:species},function(data, status){
              n = data['init'].length
              for(var i = 0; i < n; i++) {
                  dotNum[i] = parseInt(data['init'][i]['gene#'])
                  module_id[i] = data['init'][i]['moduleid']
                  module_gene[i] = data['init'][i]['genelist'].split(" ");
                  // dotNum[i] = parseInt(network[i].getElementsByClassName("network_module_gene")[0].innerText);
                  // module_id[i] = network[i].getElementsByClassName("network_module_id")[0].innerText; 
                  // module_gene[i] = network[i].getElementsByClassName("network_module_genelist")[0].innerText.split(" "); 
                  //linePoint[i] = [];    //初始化
                  //lineData[i] = [];     
                  
              } //获取初始数据，初始画图::
  
              var _series = function(n,dotNum,module_id) {
  
              var result = []; //所有的series , 两类：聚类和聚类背景
              var d = []; //每个聚类的点坐标      
              var x,y;     //小点坐标
              var r = 5; //通用半径
              var flag=[0,0,5];  //判定聚类大小，[x,y,r]，位移坐标和半径
              //AC149810.2_FG003,AC183927.3_FG004,AC184699.3_FG005, AC196059.3_FG003 
  
              for(var i = 0; i < n; i++){ //循环模块
              d = [];
              point_d = [];
              var module = {
                  name: (function(){
                      return module_id[i]
                  }()),
                  type:'scatter',
                  symbolSize: 4,               
                  silent: true, 
                  itemStyle: {
                  normal: {
                      color: (function () {
                          return moduleColor[i % 4]
                      }())
                  }
                  },            
                  data: (function () {
                       function bigDot(flag){ 
                           
                         for(var j = 0; j < dotNum[i]; j++) { 
                            r = flag[2]; 
                            x = Math.round(Math.random()*2*r);
                            y = Math.round(Math.random()*2*r);
                            if((Math.pow(x-r,2)+(Math.pow(y-r,2)) > r*r)){
                              continue;
                            } 
                            x = flag[0] + x;
                            y = flag[1] + y; //映射到坐标系
                            // console.log(i+"-"+j+"-"+dotNum[i]+"-"+module_gene[i][j]);
                            d.push([x,y,1]);
                         }
                         point.push(d); //存点，更新数据时直接拿出
                       } 
                       if(species == 'Maize'){
                        switch(dotNum[i]){
                          case 5853: {
                            flag=[100,160,17];
                            bigDot(flag);
                            break;
                          }
                          case 3687: {
                            flag=[170,80,17];
                            bigDot(flag);
                            break;
                          }
                          case 3410: {
                            flag=[80,4,13];
                            bigDot(flag);  
                            break;
                          }
                          case 2283: {
                            flag=[-4,80,17];
                            bigDot(flag);  
                            break;
                          }
                          case 2107: {
                            flag=[2,115,13];
                            bigDot(flag);  
                            break;
                          }
                          case 1222: {
                            flag=[170,115,13];
                            bigDot(flag);  
                            break;
                          }
                          case 920: {
                            flag=[170,53,13];
                            bigDot(flag);  
                            break;
                          }
                          case 834: {
                            flag=[135,160,12];
                            bigDot(flag);  
                            break;
                          }
                          case 744: {
                            flag=[171,141,8];
                            bigDot(flag);  
                            break;
                          }
                          case 606: {
                            flag=[74,170,13];
                            bigDot(flag);  
                            break;
                          }
                          case 601: {
                            flag=[53,170,10];
                            bigDot(flag);  
                            break;
                          }
                          case 593: {
                            flag=[5,54,12];
                            bigDot(flag);  
                            break;
                          }
                          case 493: {
                            flag=[58,10,10];
                            bigDot(flag);  
                            break;
                          }
                          case 446: {
                            flag=[107,7,12];
                            bigDot(flag);  
                            break;
                          }
                          case 359: {
                            flag=[132,12,9];
                            bigDot(flag);  
                            break;
                          }
                          case 328: {
                            flag=[43,17,7];
                            bigDot(flag);  
                            break;
                          }
                          case 318: {
                            flag=[16,42,6];
                            bigDot(flag);  
                            break;
                          }
                          case 273: {
                            flag=[167,38,7];
                            bigDot(flag);  
                            break;
                          }
                          case 271: {
                            flag=[160,160,6];
                            bigDot(flag);  
                            break;
                          }
                          case 252: {
                            flag=[13,142,8];
                            bigDot(flag);  
                            break;
                          }
                          case 251: {
                            flag=[28,160,6];
                            bigDot(flag);  
                            break;
                          }
                          case 211: {
                            flag=[30,27,6];
                            bigDot(flag);  
                            break;
                          }
                          case 208: {
                            flag=[150,20,5];
                            bigDot(flag);  
                            break;
                          }
                          case 193: {
                            flag=[40,170,6];
                            bigDot(flag);  
                            break;
                          }
                          default: {
                            flag=[0,0,5];
                            r = 5;
                            for(var j = 0; j < dotNum[i]; j++) {
                              x = Math.round(Math.random()*2*r);
                              y = Math.round(Math.random()*2*r);
                              if((Math.pow(x-r,2)+(Math.pow(y-r,2)) > r*r)){
                                continue;
                              } 
                              x +=30 + i%(14)*2*r;
                              y +=30 +parseInt(i/14)*2*r; //映射到坐标系
                              d.push([x,y,1]);
                            }
                            point.push(d); //存点，更新数据时直接拿出 
                          }
                        }   //switch
                        }   //maize
                        if(species == 'Rice') {
                            switch(dotNum[i]){
                                case 3783: {
                                  flag=[100,160,17];
                                  bigDot(flag);
                                  break;
                                }
                                case 1755: {
                                  flag=[170,80,17];
                                  bigDot(flag);
                                  break;
                                }
                                case 1214: {
                                  flag=[80,4,13];
                                  bigDot(flag);  
                                  break;
                                }
                                case 933: {
                                  flag=[-4,80,17];
                                  bigDot(flag);  
                                  break;
                                }
                                case 561: {
                                  flag=[2,115,13];
                                  bigDot(flag);  
                                  break;
                                }
                                case 429: {
                                  flag=[170,115,13];
                                  bigDot(flag);  
                                  break;
                                }
                                case 406: {
                                  flag=[170,53,13];
                                  bigDot(flag);  
                                  break;
                                }
                                case 392: {
                                  flag=[135,160,12];
                                  bigDot(flag);  
                                  break;
                                }
                                case 307: {
                                  flag=[171,141,8];
                                  bigDot(flag);  
                                  break;
                                }
                                case 258: {
                                  flag=[74,170,13];
                                  bigDot(flag);  
                                  break;
                                }
                                case 224: {
                                  flag=[53,170,10];
                                  bigDot(flag);  
                                  break;
                                }
                                case 209: {
                                  flag=[5,54,12];
                                  bigDot(flag);  
                                  break;
                                }
                                case 206: {
                                  flag=[58,10,10];
                                  bigDot(flag);  
                                  break;
                                }
                                case 201: {
                                  flag=[107,7,12];
                                  bigDot(flag);  
                                  break;
                                }
                                case 194: {
                                  flag=[132,12,9];
                                  bigDot(flag);  
                                  break;
                                }
                                case 170: {
                                  flag=[43,17,7];
                                  bigDot(flag);  
                                  break;
                                }
                                case 157: {
                                  flag=[16,42,6];
                                  bigDot(flag);  
                                  break;
                                }
                                case 151: {
                                  flag=[167,38,7];
                                  bigDot(flag);  
                                  break;
                                }
                                case 140: {
                                  flag=[160,160,6];
                                  bigDot(flag);  
                                  break;
                                }
                                case 136: {
                                  flag=[13,142,8];
                                  bigDot(flag);  
                                  break;
                                }
                                case 125: {
                                  flag=[90,160,6];
                                  bigDot(flag);  
                                  break;
                                }
                                case 119: {
                                  flag=[30,27,6];
                                  bigDot(flag);  
                                  break;
                                }
                                case 99: {
                                  flag=[150,20,5];
                                  bigDot(flag);  
                                  break;
                                }
                                case 92: {
                                  flag=[40,170,6];
                                  bigDot(flag);  
                                  break;
                                }
                                case 91: {
                                    flag=[90,80,5];
                                    bigDot(flag);  
                                    break;
                                  }
                                default: {
                                  flag=[0,0,5];
                                  r = 5;
                                  for(var j = 0; j < dotNum[i]; j++) {
                                    x = Math.round(Math.random()*2*r);
                                    y = Math.round(Math.random()*2*r);
                                    if((Math.pow(x-r,2)+(Math.pow(y-r,2)) > r*r)){
                                      continue;
                                    } 
                                    x +=30 + i%(14)*2*r;
                                    y +=30 +parseInt(i/14)*2*r; //映射到坐标系
                                    d.push([x,y,1]);
                                  }
                                  point.push(d); //存点，更新数据时直接拿出 
                                }
                            }   //switch
                        }   //Rice              
                      return d;
                  })() //data
               };  //module
  
               d = [];
  
               var module_background = {
                  name: module_id[i],              
                  type:'custom',
                  itemStyle:{
                    normal:{
                      color:'rgba(0,0,0,0)'
                    },
                    emphasis: {
                      borderColor:'#ccc',
                      borderWidth:2,
                      borderType:'dotted'
                    },
                  },
  
                  renderItem:function(params, api){
                    var point = api.coord([api.value(0), api.value(1)]);
                    return {
                        type: 'circle',
                        shape: {
                            cx: point[0], cy: point[1], r:api.value(2)
                        },
                        style: api.style(),
                        styleEmphasis:api.styleEmphasis()
                    } 
                  },
                  data:(function () {
                        if(flag[0] == 0 && flag[1] == 0){
                          x = 30 + r + i%(14)*2*r;
                          y = 30 + r + parseInt(i/14)*2*r; //圆心映射到坐标系
                        }else{
                          x = flag[0] + r;
                          y = flag[1] + r;
                        }
                        d.push([x,y,4*r]);
                        circlePoint[i] = [x,y,4*r];
                        return d;                     
                    })(),
                  tooltip: {
                     formatter: 'module:{a}'
                   }   
               };//module_background 
  
               result.push(module);
               result.push(module_background);
            }
  
            return result;
          }(n, dotNum, module_id);       
  
          // 指定图表的配置项和数据
  
          var option = {
              backgroundColor:['#111'],
              tooltip:{
  
              },
              grid:{},
              xAxis:{
                type: 'value',
                show:false,
                min:0,
                max:200,
                interval:_interval,
                axisLabel:{
                   textStyle:{
                      color:'#fff',
                      fontSize: 20
                   }
                }
              },
              yAxis:{
                type: 'value',
                show:false,
                min:0,
                max:200,
                interval:_interval,
                axisLabel:{
                   textStyle:{
                      color:'#fff',
                      fontSize: 20
                   }
                }
              },
              series : _series
          };
          _series.push({
                  name: 'bigCircle',              
                  type:'custom',
                  itemStyle:{
                    normal:{
                      color:'rgba(0,0,0,0)',
                      borderColor:'#fff',
                      borderWidth:5,
                      borderType:'dashed'
                    }
                  },
                  silent:true,
                  renderItem:function(params, api){
                     var point = api.coord([api.value(0), api.value(1)]);
                    return {
                        type: 'circle',
                        shape: {
                            cx: point[0], cy: point[1], r:api.value(2)
                        },
                        style: api.style(),
                    } 
                  },
                  data:[[100,100,380]]
          });
          // 使用刚指定的配置项和数据显示图表。

          myChart.setOption(option);
  
                  if( data['res'].length == 0 ){
                     console.log('没有查询结果');
                     isshow();
                     return false;
                  }
  
                  for(var i = 0; i < data['res'].length; i++) { 
                        var target_module = []; //保存gene名和所属模块名
                        // console.log("gene:"+data['gene'][i]+" res: "+data['res'][i]['moduleid']);

                        if( data['res'][i]['moduleid'] == null ) {
                            continue;
                        }
                        data['vres'][i] === undefined? networkData['module'].push([data['res'][i]['moduleid'], data['gene'][i],'no']) : 
                        networkData['module'].push([data['res'][i]['moduleid'], data['gene'][i], data['vres'][i]['v4']])
                        target_module.push(data['res'][i]['moduleid'],data['gene'][i]);
                        printDot(target_module);  //绘制色点
                        if( data['co_gene'][i].length == 0 )
                            console.log("gene:"+data['gene'][i]+"未找到共表达匹配!");
                        else {
                            for(var j = 0; j < data['co_gene'][i].length; j++){
                                for(var k = 0; k < data['res'].length; k++){
                                    if(k == i) continue;
                                    if(data['gene'][k] == data['co_gene'][i][j]['gene2']){
                                        co_gene.push([data['gene'][i],data['gene'][k],data['co_gene'][i][j]['value'],data['res'][i]['moduleid']]); 
                                        networkData['co'].push([data['res'][i]['moduleid'],data['gene'][i],data['gene'][k],data['co_gene'][i][j]['value']]);
                                    }
                                }
                            } 
                        }//获取共表达基因               
                  } //画点过程结束


                  printLine(co_gene,newDotPoint, data);
                  isshow();          
                  //myChart.hideLoading();              
  
          function printDot(target_module, co_gene) { 
              if( target_module[0] === undefined ) return false;
              var newPoint = new Object();
              var markLine = new Object();
              var index,beg,end;
            //   console.log(target_module[0] );
              for(var i = 0; i < n; i++) {
                 if(module_id[i] === target_module[0]) {
                        index = i;
                        break;
                 }
              }    
              if(typeof(newDotNum[index]) == "undefined") {
                newDotNum[index] = 0;
              }
              newDotNum[index]++; //当前模块中的色点数加一
              var nr = parseInt(Math.random() * (point[index].length - 1));
              var color = pointColor[(index % 7)];
              var lineColor = pointColor[(7 - index % 7)];
              var nx = point[index][nr][0];
              var ny = point[index][nr][1];
              newDotPoint.push([target_module[1],nx,ny,color,index,target_module[0]]);
              //AC149810.2_FG003,AC183927.3_FG004,AC184699.3_FG005, AC196059.3_FG003 
          }//function printDot   
  
          function printLine(co_gene, newDotPoint, ajaxData){ 
              var data= []; //色点坐标
              var circleData = []; //圆心坐标
              var formatterAll = [];   //所有的共表达基因
              
              //var circleSeries = [];          
              for(var i = 0; i < newDotPoint.length; i++){
                 var formatter = "<table class='co-table'><caption>co-expression</caption>"+
                 "<tr><th id='info-table-gene' >gene1</th><th id='info-table-gene' >gene2</th><th id='info-table-value'>value</th></tr>"; //提示字符
                 var co_flag = false; //判断该模块是否存在共表达基因
                 for(var j = 0; j < co_gene.length; j++) {
                     if(co_gene[j][3] == newDotPoint[i][5]){
                         formatter +="<tr><td>&nbsp"+co_gene[j][0]+"&nbsp</td>"+"<td>&nbsp"+co_gene[j][1]+"&nbsp</td>"+"<td>&nbsp"+co_gene[j][2]+"&nbsp</td></tr>";
                         co_flag = true; 
                     }
                 }
                 if(!co_flag) {
                     formatte = "module:"+newDotPoint[i][5]+'<br/>Co expressed genes did not exist';
                 }
                 else  {formatter += "</table>";}

                 formatterAll[newDotPoint[i][4]] = formatter;

                 data.push({
                    name: newDotPoint[i][0],
                    value: [newDotPoint[i][1],newDotPoint[i][2],0],
                    itemStyle: {
                       normal: {
                         color: newDotPoint[i][3]
                       }
                    },
                    tooltip: {
                      formatter: function(params){
                          return params.name;
                      }
                    },
                 });
                 //这里可以优化去重
                 _series.push({ 
                      name:newDotPoint[i][5],             
                      type:'custom',
                      itemStyle:{
                        normal:{
                          color:'rgba(0,0,0,0)'
                        },
                        emphasis: {
                          borderColor:'#ccc',
                          borderWidth:2,
                          borderType:'dotted'
                        },
                      },
                      z: 3,
                      renderItem: function(params, api){
                         var point = api.coord([api.value(0), api.value(1)]);
                         var k = (api.value(0)-100)/(api.value(1)-100);
                         var offsetX = 0;
                         var offsetY = 0;
                         var textAlign;
                         Math.abs(k) > 1? r = 110:r = 105;
                         (api.value(0)-100) > 0? textAlign = 'left': textAlign = 'right';
                         if(api.value(1)-100 < 0){
                            var y2 = (-1)*r/Math.sqrt(k*k+1)+100;
                         }else {
                            var y2 = r/Math.sqrt(k*k+1)+100;
                         }
                         var x2 = y2*k-(k-1)*100;
                         var linePoint = api.coord([x2,y2]);
            
                        return {
                            type:'group',
                            children: [{
                                  type: 'circle',
                                  shape: {
                                      cx: point[0], cy: point[1], r:api.value(2)
                                  },
                                  style: api.style(),
                                  styleEmphasis:api.styleEmphasis()
                              },
                              {
                                  type: 'line',
                                  shape: {
                                      x1: point[0], y1: point[1], x2: linePoint[0], y2: linePoint[1]
                                  },
                                  style:{
                                    stroke: '#ddd',
                                    lineWidth: 1
                                  }
                              },
                              {
                                  type: 'text',
                                  style: {
                                      text: " " + params.seriesName + " ",
                                      x: linePoint[0],
                                      y: linePoint[1],
                                      font:'1.3em "Open Sans", sans-serif',
                                      fill: '#ddd',
                                      textAlign: textAlign,
                                      textVerticalAlign: 'middle'
                                  }
                              }
                            ]                        
                        } 
                      },
                      data: [{
                          name: newDotPoint[i][4] + "",
                          value:circlePoint[newDotPoint[i][4]]
                        }],
                      tooltip: {
                          formatter: "Click the module to see detailed information !",
                          textStyle: {
                              fontFamily: 'Microsoft YaHei'
                          }
                        
                      }
                   }); 
              }  //确定圆心坐标及色点坐标
  
              var link = [];
              var formatter = [];
              for(var i = 0; i < co_gene.length; i++){
                  link.push({
                    source: co_gene[i][0],
                    target: co_gene[i][1],
                    value: co_gene[i][2]
                  });
              } //确定连线          
  
             var newSeries = {
                 type: 'graph',
                 name: 'dotLine',
                 hoverAnimation: false,
                 legendHoverLink: false,
                 coordinateSystem: 'cartesian2d',
                 label: {
                    normal: {
                       show: false
                    },
                    emphasis: {
                       show: false
                    }
                 },
                 data: data,
                 links: link,             
                 lineStyle: {
                      normal: {
                          color: 'source',
                          curveness: 0.3,
                          width: 2,
                          opacity: 0.4
                      }
                 },
                 z:3
             }
             // var lineData = [];            
             _series.push(newSeries);
             option = {
                  series : _series
               }          
  
              myChart.setOption(option);

              var img = new Image();
              img.src = myChart.getDataURL({
                pixelRatio: 4,
              });
              $('#canvas_network').before("<a class='download-link' href='"+img.src+"' target='blank'>click here to see HD map !</a>");

              myChart.on('click', function (params) {
                if(params.seriesType === 'custom' && params.seriesName !== 'bigCircle' && params.name != 'undefined') {
                    $('.main-genes').hide();
                    console.log(params.name)
                    console.log(formatterAll[params.name])
                    console.log(ajaxData['gene'])
                    var selfGene = ajaxData['gene'];
                    var vself = ajaxData['vres'];
                    console.log(vself);
                    var selfPoint = []; //存储本模块的色点
                    var count = 0;
                    if(vself.length !== 0) {
                        var infoModule = "<table><caption>module genes</caption><tr><th id='info-table-gene'>gene</th><th id='info-table-v4'>v4</th><th id='info-table-name'>"+params.seriesName+"</th></tr>" // 表格
                        for ( var i = 0; i < newDotPoint.length; i++ ) {
                            if( newDotPoint[i][4] == params.name ) selfPoint.push(newDotPoint[i][0])
                        }
    
                        for ( var j = 0; j < selfGene.length; j++ ) {
                            for( var k = 0; k < selfPoint.length; k++ ) {
                                if(selfGene[j] == selfPoint[k]) {
                                    infoModule += "<tr><td>"+selfGene[j]+"</td><td>"+vself[j]['v4']+"</td>";
                                    infoModule += "<td class='yes'>√</td>"
                                    count++;
                                }    
                                infoModule += "</tr>";
                            }                   
                        }
                    }    
                    else {
                        var infoModule = "<table><caption>module genes</caption><tr><th id='info-table-gene'>gene</th><th id='info-table-name'>"+params.seriesName+"</th></tr>" // 表格
                        for ( var i = 0; i < newDotPoint.length; i++ ) {
                            if( newDotPoint[i][4] == params.name ) selfPoint.push(newDotPoint[i][0])
                        }
    
                        for ( var j = 0; j < selfGene.length; j++ ) {
                            for( var k = 0; k < selfPoint.length; k++ ) {
                                if(selfGene[j] == selfPoint[k]) {
                                    infoModule += "<tr><td>"+selfGene[j]+"</td>";
                                    infoModule += "<td class='yes'>√</td>"
                                    count++;
                                }    
                            }
                            infoModule += "</tr>"
                        }
                    }
                    infoModule += "</table>"
                    console.log( ajaxData['res'] );
                    console.log( selfPoint );

                    $('.container').prepend(
                        "<div class='main-info' >"+
                        "<p>Module&nbsp"+params.seriesName+"&nbspdetails</p>"+
                        "<button onclick='goBack()'>return</button>"+
                        "<div class='info-module'>"+
                            infoModule+
                        "</div>"+
                        "<div class='info-co'>"+
                            formatterAll[params.name]+
                        "</div>"+
                        "</div>"
                    )
                }
               });
          }
  
          });
           }
           
        });        
});